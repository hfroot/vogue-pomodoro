<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>ðŸª¼Vogue pomodoro</title>
	</head>
	<body>
		<h1>Vogue pomodoro</h1>
		<p>Necesitas trabajar? Necesitas practicar tu vogue?</p>
		<p>Se presentoooo</p>
		<p>El ðŸª¼Vogue pomodoroðŸª¼!!</p>
		<button id="start-btn">Empezar el timer!</button>

		<!-- could put this on another page and make the button a link and the page auto starts the timer -->
		<h2 id="state-heading" aria-live="polite">Tocar el botÃ³n para empezar el timer</h2>
		<p id="remaining-time"><span id="remaining-seconds">?</span> segundos</p>

		<iframe id="musicbox" width="100%" height="300" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/soundcloud%253Atracks%253A777489118&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe><div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;"><a href="https://soundcloud.com/lazyflowlazyflow" title="Lazy Flow" target="_blank" style="color: #cccccc; text-decoration: none;">Lazy Flow</a> Â· <a href="https://soundcloud.com/lazyflowlazyflow/tropical-vogue-vol3-mixtape-feat-vinii-revlon-khyree-lemon-hanabi-the-kunt-matyouz-laduree" title="Tropical Vogue Vol.3 Mixtape (feat. Vinii Revlon, Khyree, LÃ¨mon, Hanabi The Kunt, Matyouz LaDurÃ©e)" target="_blank" style="color: #cccccc; text-decoration: none;">Tropical Vogue Vol.3 Mixtape (feat. Vinii Revlon, Khyree, LÃ¨mon, Hanabi The Kunt, Matyouz LaDurÃ©e)</a></div>

		<h2>ConfiguracÃ­on</h2>
		<!-- either convert to readonly when playing or make updates configure on the fly -->
		<!-- add docs: hard refresh to clear data; close to stop -->
		<form>
			<label>
				Calentamiento
				<input name="warmupSeconds" type="number" min="0" class="preferences-input" />
				(segundos)
			</label>
			<label>
				Baile
				<input name="danceSeconds" type="number" min="0" class="preferences-input" />
				(segundos)
			</label>
			<label>
				Pausa total
				<input name="totalRestSeconds" type="number" min="0" class="preferences-input" />
				(segundos)
			</label>
			<label>
				Trabajo sin mÃºsica
				<input name="workSeconds" type="number" min="0" class="preferences-input" />
				(segundos)
			</label>
			<label>
				DondÃ© empezar el track
				<input name="startAtMilliseconds" type="number" min="0" class="preferences-input" />
				(milisegundos)
			</label>
		</form>
	</body>
</html>

<!-- Usually generated by the server, but we like to start fast and start small -->
<!-- For first step user customisation, could put this in localStorage and tell people how to modify that -->
<!-- work on getting the track data customisable in here -->

<script id="data" type="application/json">
{
	"warmupSeconds": 60,
	"danceSeconds": 60,
	"totalRestSeconds": 300,
	"workSeconds": 1800,
	"startAtMilliseconds": 0
}
</script>
<!-- other data
{
	"warmupSeconds": 6,
	"danceSeconds": 6,
	"totalRestSeconds": 18,
	"workSeconds": 5,
	"startAtMilliseconds": 560000
}
-->

<script src="https://w.soundcloud.com/player/api.js"></script>

<!-- Static -->
<!-- https://developers.soundcloud.com/docs/api/html5-widget#playground -->
<script>
	const preferences = JSON.parse(document.getElementById("data").text);

	const musicboxElement = document.getElementById("musicbox");
	const musicbox = SC.Widget(musicboxElement);

	const heading = document.getElementById("state-heading");
	const headingTexts = {
		warmUp: "Get ready...",
		dance: "Work that pussy",
		rest: "Rest that pussy",
		work: "Get that pussy to work"
	}

	const startCountdownDisplay = (seconds) => {
		const timerElement = document.getElementById("remaining-seconds")
		timerElement.innerText = seconds
		const countdownInterval = setInterval(() => {
			seconds--
			if (seconds <= 0) clearInterval(countdownInterval)
			else timerElement.innerText = seconds
		}, 1000)
	}

	const startBtn = document.getElementById("start-btn")
	startBtn.addEventListener("click", () => {
		startBtn.innerText = "Reset the timer"
		musicbox.seekTo(preferences.startAtMilliseconds);
		danceWorkCycle()
	})

	const danceWorkCycle = () => {
		startCountdownDisplay(preferences.warmupSeconds)
		heading.innerText = headingTexts.warmUp
		musicbox.play();
		const midVolume = 30;
		const warmupMilliseconds = preferences.warmupSeconds * 1000
		const fadeToMidDuration = warmupMilliseconds;
	    fadeTo(musicbox, 0, midVolume, fadeToMidDuration);

		const thatMusicBox = musicbox;
		setTimeout(() => {
			startCountdownDisplay(preferences.danceSeconds)
			heading.innerText = headingTexts.dance
			fadeTo(thatMusicBox, midVolume, 100, 300);
		}, warmupMilliseconds)

		// can't think of a better name for this variable, but really the music fades to 10 after, it doesn't stop yet
		const musicPlayingMilliseconds = warmupMilliseconds + preferences.danceSeconds * 1000
		setTimeout(() => {
			heading.innerText = headingTexts.rest
			const timeRemaining = (preferences.totalRestSeconds - preferences.danceSeconds - preferences.warmupSeconds) || 10;
			startCountdownDisplay(timeRemaining)
			fadeTo(thatMusicBox, midVolume, 10, timeRemaining * 1000);
		}, musicPlayingMilliseconds)

		const restMilliseconds = preferences.totalRestSeconds * 1000
		setTimeout(() => {
			startCountdownDisplay(preferences.workSeconds)
			heading.innerText = headingTexts.work
			musicbox.pause();
			setTimeout(() => {
				danceWorkCycle()
			}, preferences.workSeconds * 1000);
		}, restMilliseconds)
	}

	// Source - https://stackoverflow.com/a
	// Posted by Matt Kenefick
	// Retrieved 2026-01-20, License - CC BY-SA 4.0
	// Adapted by hfroot to manipulate volume instead of opacity

	function fadeTo(theMusicbox, fromValue = 0, toValue = 0, duration = 200) {
		// could use theMusicbox.getVolume but that involves another layer of callback that
		// I can't be bothered to write given we control the volume
	    const startTime = Date.now();

	    // Determines time (ms) between each frame. Sometimes you may not
	    // want a full 60 fps for performance reasons or aesthetic 
	    const framerate = 1000 / 60; // 60fps
	    
	    // Store reference to interval (number) so we can clear it later
	    let interval = setInterval(() => {
	        const currentTime = Date.now();

	        // This creates a normalized number between now vs when we
	        // started and how far into our desired duration it goes
	        const timeDiff = (currentTime - startTime) / duration;

	        // Interpolate our values using the ratio from above
	        const value = fromValue - (fromValue - toValue) * timeDiff;
	        
	        // If our ratio is >= 1, then we're done.. so stop processing
	        if (timeDiff >= 1) {
	            clearInterval(interval);
	            interval = 0;
	        }

	        theMusicbox.setVolume(value);
	    }, framerate)
	}

	const inputs = document.getElementsByClassName("preferences-input")
	console.log(inputs)

	Array.prototype.forEach.call(
		inputs,
		(inputElement) => {
			// fix this to allow 0 value
			if (!preferences[inputElement.name]) console.error(`${inputElement.name} not a valid preference`)
			inputElement.placeholder = preferences[inputElement.name]
			// NB: only called on blur
			inputElement.addEventListener("change", (event) => {
				// not sure if Number or Number.parseInt would be better
				preferences[inputElement.name] = Number(event.srcElement.value)
			}
		)
	})
</script>

<style>
	label {
		display: block;
		margin-bottom: 1rem;
	}
	h1, h2 {
		color: #e041e8;
	}
	input.preferences-input {
		margin-right: 0.2rem;
	}
</style>